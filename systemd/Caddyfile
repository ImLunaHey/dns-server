# DNS Server Caddy Configuration
# This file configures Caddy as a reverse proxy for the DNS server and client
# The install script will replace {$DOMAIN} with the actual domain/IP
# Caddy will automatically bind to the domain/IP specified

{$DOMAIN:localhost} {
  # Bind to the domain/IP (Caddy will handle external connections)
  # If using an IP, explicitly bind to that IP
  # If using a domain, Caddy will bind to all interfaces (0.0.0.0) for that domain
  # Note: The install script will add "bind" directive for IP addresses
  
  # Proxy DNS-over-HTTPS (DoH) requests to the server (port 3001 on localhost)
  reverse_proxy /dns-query 127.0.0.1:3001 {
    header_up Host {host}
    header_up X-Real-IP {remote}
    header_up X-Forwarded-For {remote}
    header_up X-Forwarded-Proto {scheme}
  }
  
  # Proxy API requests to the server (port 3001 on localhost)
  reverse_proxy /api/* 127.0.0.1:3001 {
    header_up Host {host}
    header_up X-Real-IP {remote}
    header_up X-Forwarded-For {remote}
    header_up X-Forwarded-Proto {scheme}
  }
  
  # Proxy all other requests to the client (port 3000 on localhost)
  reverse_proxy /* 127.0.0.1:3000 {
    header_up Host {host}
    header_up X-Real-IP {remote}
    header_up X-Forwarded-For {remote}
    header_up X-Forwarded-Proto {scheme}
  }
  
  # Security headers
  header {
    X-Content-Type-Options "nosniff"
    X-Frame-Options "DENY"
    X-XSS-Protection "1; mode=block"
    Referrer-Policy "strict-origin-when-cross-origin"
  }
  
  # Enable compression
  encode gzip zstd
}

